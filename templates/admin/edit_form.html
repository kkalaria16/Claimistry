{% extends "base.html" %}

{% block title %}Edit Form - Admin{% endblock %}

{% block styles %}
<style>
    .form-section {
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    /* Validation styles */
    .is-invalid {
        border-color: #dc3545;
        padding-right: calc(1.5em + 0.75rem);
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
    }
    
    .invalid-feedback {
        width: 100%;
        margin-top: 0.25rem;
        font-size: 0.875em;
        color: #dc3545;
    }
    
    .was-validated .form-control:invalid, .form-control.is-invalid {
        border-color: #dc3545;
    }
    .entry-row {
        background-color: white;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
        border: 1px solid #e9ecef;
        transition: all 0.2s;
    }
    .entry-row:hover {
        box-shadow: 0 0.125rem 0.5rem rgba(0, 0, 0, 0.1);
    }
    .remove-entry {
        color: #dc3545;
        cursor: pointer;
        font-size: 1.25rem;
        line-height: 1;
        opacity: 0.7;
        transition: opacity 0.2s;
    }
    .remove-entry:hover {
        opacity: 1;
    }
    .add-entry-btn {
        margin-top: 0.5rem;
    }
    .form-actions {
        background-color: #f8f9fa;
        padding: 1rem;
        border-radius: 0.5rem;
        position: sticky;
        bottom: 1rem;
        z-index: 1000;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">Edit Reimbursement Form</h2>
        <a href="{{ url_for('view_forms') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i> Back to Form
        </a>
    </div>

    <form method="POST" id="editForm" class="needs-validation" novalidate>
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <!-- Form Header Section -->
        <div class="form-section">
            <h4 class="mb-4">
                <i class="fas fa-file-alt me-2"></i>Form Details
            </h4>
            
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="employee_id" class="form-label">Employee ID</label>
                        <input type="text" class="form-control" id="employee_id" name="employee_id" 
                               value="{{ form.employee_id }}" required
                               pattern="[A-Za-z0-9]+" minlength="3" maxlength="50">
                        <div class="invalid-feedback">
                            Please provide a valid employee ID (3-50 alphanumeric characters).
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="employee_name" class="form-label">Employee Name</label>
                        <input type="text" class="form-control" id="employee_name" name="employee_name"
                               value="{{ employee.name if employee and employee.name else (extracted_name or '') }}" required
                               minlength="2" maxlength="100" pattern="[A-Za-z\s]+">
                        <div class="invalid-feedback">
                            Please provide a valid name (2-100 letters and spaces only).
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="designation" class="form-label">Designation</label>
                        <input type="text" class="form-control" id="designation" name="designation"
                               value="{{ form.designation or '' }}">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="location" class="form-label">Location</label>
                        <input type="text" class="form-control" id="location" name="location"
                               value="{{ form.location or '' }}">
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="from_date" class="form-label">From Date</label>
                            <input type="date" class="form-control" id="from_date" name="from_date"
                                   value="{{ form.from_date.strftime('%Y-%m-%d') if form.from_date else '' }}" required>
                        </div>
                        <div class="col-md-6">
                            <label for="to_date" class="form-label">To Date</label>
                            <input type="date" class="form-control" id="to_date" name="to_date"
                                   value="{{ form.to_date.strftime('%Y-%m-%d') if form.to_date else '' }}" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="total_amount" class="form-label">Total Amount (₹)</label>
                        <div class="input-group">
                            <span class="input-group-text">₹</span>
                            <input type="number" step="0.01" class="form-control" id="total_amount" name="total_amount"
                                   value="{{ '%.2f'|format(form.total_amount) if form.total_amount else '0.00' }}" 
                                   min="0" required>
                        </div>
                        <div class="invalid-feedback">
                            Please enter a valid amount (minimum 0).
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bank Details Section -->
        <div class="form-section">
            <h4 class="mb-4">
                <i class="fas fa-university me-2"></i>Bank Details
            </h4>
            
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="bank_name" class="form-label">Bank Name</label>
                        <input type="text" class="form-control" id="bank_name" name="bank_name"
                               value="{{ employee.bank_name if employee else '' }}">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="account_number" class="form-label">Account Number</label>
                        <input type="text" class="form-control" id="account_number" name="account_number"
                               value="{{ employee.account_number if employee else '' }}">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="ifsc_code" class="form-label">IFSC Code</label>
                        <input type="text" class="form-control" id="ifsc_code" name="ifsc_code"
                               value="{{ employee.ifsc_code if employee else '' }}">
                    </div>
                </div>
            </div>
        </div>

        <!-- Expense Entries Section -->
        <div class="form-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="mb-0">
                    <i class="fas fa-receipt me-2"></i>Expense Entries
                </h4>
                <button type="button" class="btn btn-primary" id="addEntry">
                    <i class="fas fa-plus me-1"></i> Add Entry
                </button>
            </div>
            
            <div id="entriesContainer">
                {% for entry in entries %}
                <div class="entry-row position-relative" data-entry-id="{{ entry.id }}">
                    <input type="hidden" name="entry_id" value="{{ entry.id }}">
                    <div class="row g-3">
                        <div class="col-md-2">
                            <label class="form-label small text-muted">Date</label>
                            <input type="date" class="form-control form-control-sm" name="entry_date" required
                                   value="{{ entry.date.strftime('%Y-%m-%d') if entry.date else '' }}"
                                   max="{{ now.strftime('%Y-%m-%d') }}">
                            <div class="invalid-feedback">
                                Please select a valid date (not in the future).
                            </div>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small text-muted">From</label>
                            <input type="text" class="form-control form-control-sm" name="entry_from"
                                   value="{{ entry.from_location or '' }}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small text-muted">To</label>
                            <input type="text" class="form-control form-control-sm" name="entry_to"
                                   value="{{ entry.to_location or '' }}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small text-muted">Purpose</label>
                            <input type="text" class="form-control form-control-sm" name="entry_purpose"
                                   value="{{ entry.purpose or '' }}">
                        </div>
                        <div class="col-md-1">
                            <label class="form-label small text-muted">Mode</label>
                            <select class="form-select form-select-sm" name="entry_mode">
                                <option value="">-- Select --</option>
                                <option value="2-Wheeler" {% if entry.mode_of_travel == '2-Wheeler' %}selected{% endif %}>2-Wheeler</option>
                                <option value="4-Wheeler" {% if entry.mode_of_travel == '4-Wheeler' %}selected{% endif %}>4-Wheeler</option>
                                <option value="Auto" {% if entry.mode_of_travel == 'Auto' %}selected{% endif %}>Auto</option>
                                <option value="Cab" {% if entry.mode_of_travel == 'Cab' %}selected{% endif %}>Cab</option>
                                <option value="Other" {% if entry.mode_of_travel == 'Other' %}selected{% endif %}>Other</option>
                            </select>
                        </div>
                        <div class="col-md-1">
                            <label class="form-label small text-muted">Distance (km)</label>
                            <input type="number" step="0.1" class="form-control form-control-sm" name="entry_distance"
                                   value="{{ '%.1f'|format(entry.distance_km) if entry.distance_km is not none else '' }}">
                        </div>
                        <div class="col-md-1">
                            <label class="form-label small text-muted">Amount (₹)</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">₹</span>
                                <input type="number" step="0.01" class="form-control" name="entry_amount" required
                                       value="{{ '%.2f'|format(entry.amount_rs) if entry.amount_rs is not none else '0.00' }}"
                                       min="0">
                            </div>
                            <div class="invalid-feedback">
                                Please enter a valid amount (minimum 0).
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-link text-danger position-absolute top-0 end-0 p-1 remove-entry" 
                            title="Remove entry">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions mt-4">
            <div class="d-flex justify-content-end gap-2">
                <a href="{{ url_for('view_forms') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-times me-1"></i> Cancel
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save me-1"></i> Save Changes
                </button>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
// Form validation
(function () {
    'use strict'
    
    // Fetch all the forms we want to apply custom Bootstrap validation styles to
    const forms = document.querySelectorAll('.needs-validation')
    
    // Loop over them and prevent submission
    Array.from(forms).forEach(form => {
        form.addEventListener('submit', event => {
            if (!form.checkValidity()) {
                event.preventDefault()
                event.stopPropagation()
            }
            
            form.classList.add('was-validated')
            
            // Custom validation: Check if at least one entry has an amount > 0
            const hasValidEntries = Array.from(document.querySelectorAll('input[name="entry_amount"]'))
                .some(input => parseFloat(input.value) > 0);
                
            if (!hasValidEntries) {
                event.preventDefault();
                const firstAmountInput = document.querySelector('input[name="entry_amount"]');
                if (firstAmountInput) {
                    firstAmountInput.focus();
                    const feedback = document.createElement('div');
                    feedback.className = 'invalid-feedback d-block';
                    feedback.textContent = 'Please add at least one expense entry with an amount greater than 0.';
                    firstAmountInput.closest('.entry-row').appendChild(feedback);
                }
                return false;
            }
        }, false)
    })
})();

$(document).ready(function() {
    // Add new entry
    $('#addEntry').click(function() {
        const today = new Date().toISOString().split('T')[0];
        const newEntry = `
            <div class="entry-row position-relative">
                <input type="hidden" name="entry_id" value="">
                <div class="row g-3">
                    <div class="col-md-2">
                        <label class="form-label small text-muted">Date</label>
                        <input type="date" class="form-control form-control-sm" name="entry_date" 
                               max="${today}" required>
                        <div class="invalid-feedback">
                            Please select a valid date (not in the future).
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small text-muted">From</label>
                        <input type="text" class="form-control form-control-sm" name="entry_from">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small text-muted">To</label>
                        <input type="text" class="form-control form-control-sm" name="entry_to">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small text-muted">Purpose</label>
                        <input type="text" class="form-control form-control-sm" name="entry_purpose">
                    </div>
                    <div class="col-md-1">
                        <label class="form-label small text-muted">Mode</label>
                        <select class="form-select form-select-sm" name="entry_mode">
                            <option value="">-- Select --</option>
                            <option value="2-Wheeler">2-Wheeler</option>
                            <option value="4-Wheeler">4-Wheeler</option>
                            <option value="Auto">Auto</option>
                            <option value="Cab">Cab</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="col-md-1">
                        <label class="form-label small text-muted">Distance (km)</label>
                        <input type="number" step="0.1" class="form-control form-control-sm" name="entry_distance">
                    </div>
                    <div class="col-md-1">
                        <label class="form-label small text-muted">Amount (₹)</label>
                        <div class="input-group input-group-sm">
                            <span class="input-group-text">₹</span>
                            <input type="number" step="0.01" class="form-control" name="entry_amount" 
                                   min="0" required>
                        </div>
                        <div class="invalid-feedback">
                            Please enter a valid amount (minimum 0).
                        </div>
                    </div>
                </div>
                <button type="button" class="btn btn-link text-danger position-absolute top-0 end-0 p-1 remove-entry" 
                        title="Remove entry">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        $('#entriesContainer').append(newEntry);
        updateRemoveButtons();
    });

    // Remove entry
    function updateRemoveButtons() {
        $('.remove-entry').off('click').on('click', function() {
            if ($('.entry-row').length > 1) {
                $(this).closest('.entry-row').fadeOut(200, function() {
                    $(this).remove();
                    updateTotalAmount();
                });
            } else {
                // Clear all fields instead of removing the last row
                const row = $(this).closest('.entry-row');
                row.find('input:not([name="entry_id"]), select').val('');
                row.find('input[name="entry_amount"]').val('0.00');
            }
        });
    }

    // Calculate total amount when any amount changes
    $(document).on('input', 'input[name="entry_amount"]', function() {
        // Validate the current input
        this.setCustomValidity('');
        if (this.validity.rangeUnderflow) {
            this.setCustomValidity('Amount must be 0 or greater');
        }
        updateTotalAmount();
    });

    function updateTotalAmount() {
        let total = 0;
        $('input[name="entry_amount"]').each(function() {
            total += parseFloat($(this).val() || 0);
        });
        $('#total_amount').val(total.toFixed(2));
    }

    // Initialize
    updateRemoveButtons();
    updateTotalAmount();

    // Add real-time validation for employee ID
    $('#employee_id').on('input', function() {
        this.setCustomValidity('');
        if (this.validity.patternMismatch) {
            this.setCustomValidity('Employee ID can only contain letters and numbers');
        }
    });
    
    // Add real-time validation for employee name
    $('#employee_name').on('input', function() {
        this.setCustomValidity('');
        if (this.validity.patternMismatch) {
            this.setCustomValidity('Name can only contain letters and spaces');
        }
    });
    
    // Initialize date pickers with max date today
    $('input[type="date"]').attr('max', new Date().toISOString().split('T')[0]);
});
</script>
{% endblock %}
