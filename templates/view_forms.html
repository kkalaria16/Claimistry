{% extends "base.html" %}

{% block title %}View Processed Forms{% endblock %}

{% block content %}
<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
<div class="container mt-4">
    <h2>Processed Reimbursement Forms</h2>
    
    <!-- Date Range Filter -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>Filter Forms</h5>
        </div>
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-3">
                    <label for="from_date" class="form-label">From Date</label>
                    <input type="date" class="form-control" id="from_date" name="from_date" 
                           value="{{ request.args.get('from_date', '') }}">
                </div>
                <div class="col-md-3">
                    <label for="to_date" class="form-label">To Date</label>
                    <input type="date" class="form-control" id="to_date" name="to_date"
                           value="{{ request.args.get('to_date', '') }}">
                </div>
                <div class="col-md-3">
                    <label for="employee_id" class="form-label">Employee ID</label>
                    <input type="text" class="form-control" id="employee_id" name="employee_id"
                           value="{{ request.args.get('employee_id', '') }}" placeholder="Leave blank for all">
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary me-2">Filter</button>
                    <a href="{{ url_for('view_forms') }}" class="btn btn-secondary">Clear</a>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Forms List -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Processed Forms</h5>
            <a href="{{ url_for('monthly_summary_selector') }}" class="btn btn-success">
                View Monthly Summary
            </a>
        </div>
        <div class="card-body">
            {% if forms %}
            <div class="table-responsive">
    <div class="mb-2">
        <button id="bulk-delete-btn" class="btn btn-danger btn-sm" disabled>Delete Selected</button>
    </div>
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all-forms"></th>
                            <th>Form ID</th>
                            <th>Employee</th>
                            <th>Period</th>
                            <th>Location</th>
                            <th>Total Amount</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for form_data in forms %}
                        <tr>
                            <td><input type="checkbox" class="form-checkbox" name="selected_forms" value="{{ form_data.id }}"></td>
                            <td>{{ form_data.id }}</td>
                            <td>
                                {{ form_data.employee.name if form_data.employee and form_data.employee.name else (form_data.extracted_name or '') }}
                                <br><small class="text-muted">{{ form_data.employee_id }}</small>
                            </td>
                            <td>
                                {{ form_data.from_date.strftime('%d-%b-%Y') if form_data.from_date else 'N/A' }}
                                <br>to<br>
                                {{ form_data.to_date.strftime('%d-%b-%Y') if form_data.to_date else 'N/A' }}
                            </td>
                            <td>{{ form_data.location or 'N/A' }}</td>
                            <td>₹{{ "%.2f"|format(form_data.total_amount) if form_data.total_amount else '0.00' }}</td>
                            
                            <td>
                                <a href="#" class="btn btn-sm btn-info view-details" 
                                   data-bs-toggle="modal" data-bs-target="#detailsModal" 
                                   data-form-id="{{ form_data.id }}">
                                    View Details
                                </a>
                                <button type="button"
        class="btn btn-sm btn-danger"
        data-delete-url="{{ url_for('delete_form', form_id=form_data.id) }}">
    <i class="fas fa-trash-alt"></i> Delete
</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info">No forms found matching the criteria.</div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Expense Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="expenseDetails">
                Loading...
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<!-- Bulk Delete Confirmation Modal -->
<div class="modal fade" id="bulkDeleteModal" tabindex="-1" aria-labelledby="bulkDeleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="bulkDeleteModalLabel">Confirm Bulk Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete the selected forms? This action cannot be undone.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="confirm-bulk-delete" class="btn btn-danger">Delete Selected</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Handle view details button click
    $('.view-details').on('click', function() {
        const formId = $(this).data('form-id');
        const $modal = $('#detailsModal');
        const $detailsContent = $('#expenseDetails');
        
        // Show loading state
        $detailsContent.html(`
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 mb-0">Loading form details...</p>
            </div>
        `);
        
        // Show the modal immediately
        const modal = new bootstrap.Modal($modal[0]);
        modal.show();
        
        // Fetch expense details via AJAX
        $.ajax({
            url: `/form_details_ajax/${formId}`,
            method: 'GET',
            dataType: 'html',
            success: function(data) {
                $detailsContent.html(data);
                // Re-initialize any tooltips in the loaded content
                var tooltipTriggerList = [].slice.call($detailsContent.find('[data-bs-toggle="tooltip"]'));
                tooltipTriggerList.forEach(function (tooltipTriggerEl) {
                    new bootstrap.Tooltip(tooltipTriggerEl);
                });
            },
            error: function(xhr, status, error) {
                console.error('Error loading form details:', status, error);
                let errorMsg = 'Failed to load expense details. ';
                if (xhr.status === 404) {
                    errorMsg += 'The requested form was not found.';
                } else if (xhr.status === 500) {
                    errorMsg += 'A server error occurred. Please try again later.';
                } else if (xhr.responseText) {
                    errorMsg += xhr.responseText;
                }
                
                $detailsContent.html(`
                    <div class="alert alert-danger m-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${errorMsg}
                    </div>
                `);
            },
            complete: function() {
                // Any cleanup after request is complete
            }
        });
    });
    
    // Initialize tooltips in the main content
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('.tooltip-initialize'));
    tooltipTriggerList.forEach(function (tooltipTriggerEl) {
        new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Clean up tooltips when modal is closed
    $('#detailsModal').on('hidden.bs.modal', function () {
        $('.tooltip').remove(); // Clean up any lingering tooltips
    });

    // --- Bulk Delete Logic ---
    // Select all logic
    $('#select-all-forms').on('change', function() {
        $('.form-checkbox').prop('checked', this.checked);
        $('#bulk-delete-btn').prop('disabled', $('.form-checkbox:checked').length === 0);
    });
    $(document).on('change', '.form-checkbox', function() {
        const total = $('.form-checkbox').length;
        const checked = $('.form-checkbox:checked').length;
        $('#select-all-forms').prop('checked', total === checked);
        $('#bulk-delete-btn').prop('disabled', checked === 0);
    });
    // Bulk delete button click
    $('#bulk-delete-btn').on('click', function() {
        $('#bulkDeleteModal').modal('show');
    });
    // Confirm bulk delete
    $('#confirm-bulk-delete').on('click', function() {
        const selected = $('.form-checkbox:checked').map(function() { return this.value; }).get();
        if (selected.length === 0) return;
        // Get CSRF token from a hidden input in the page (reuse from delete modal or add to page)
        const csrf_token = $('input[name="csrf_token"]').val();
        $.ajax({
            url: '/bulk_delete_forms',
            method: 'POST',
            contentType: 'application/json',
            headers: { 'X-CSRFToken': csrf_token },
            data: JSON.stringify({ form_ids: selected }),
            success: function(response) {
                location.reload();
            },
            error: function(xhr) {
                alert('Bulk delete failed!');
                $('#bulkDeleteModal').modal('hide');
            }
        });
    });
});

// Live update for Forms table
function renderFormsTable(forms) {
    var $tbody = $('table.table-striped tbody');
    if (!$tbody.length) return;
    $tbody.empty();
    forms.forEach(function(form) {
        var html = `<tr>
            <td></td>
            <td>${form.id}</td>
            <td>${form.name}<br><small class="text-muted">${form.employee_id}</small></td>
            <td>${form.from_date}<br>to<br>${form.to_date}</td>
            <td>${form.location}</td>
            <td>₹${parseFloat(form.total_amount).toFixed(2)}</td>
            <td>
                <a href="#" class="btn btn-sm btn-info view-details" data-bs-toggle="modal" data-bs-target="#detailsModal" data-form-id="${form.id}">View Details</a>
                <button type="button" class="btn btn-sm btn-danger" data-delete-url="/delete_form/${form.id}"><i class="fas fa-trash-alt"></i> Delete</button>
            </td>
        </tr>`;
        $tbody.append(html);
    });
}
var lastForms = null;
function pollForms() {
    // If any modal is open, skip updating the table
    if ($('.modal.show').length) return;
    $.getJSON('/api/forms', function(data) {
        var json = JSON.stringify(data);
        if (json !== lastForms) {
            renderFormsTable(data);
            lastForms = json;
            attachViewDetailsHandler();
        }
    });
}

function attachViewDetailsHandler() {
    $('.view-details').off('click').on('click', function() {
        const formId = $(this).data('form-id');
        const $modal = $('#detailsModal');
        const $detailsContent = $('#expenseDetails');
        $detailsContent.html(`
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 mb-0">Loading form details...</p>
            </div>
        `);
        const modal = new bootstrap.Modal($modal[0]);
        modal.show();
        $.ajax({
            url: `/form_details_ajax/${formId}`,
            method: 'GET',
            dataType: 'html',
            success: function(data) {
                $detailsContent.html(data);
                var tooltipTriggerList = [].slice.call($detailsContent.find('[data-bs-toggle="tooltip"]'));
                tooltipTriggerList.forEach(function (tooltipTriggerEl) {
                    new bootstrap.Tooltip(tooltipTriggerEl);
                });
            },
            error: function(xhr, status, error) {
                let errorMsg = 'Failed to load expense details. ';
                if (xhr.status === 404) {
                    errorMsg += 'The requested form was not found.';
                } else if (xhr.status === 500) {
                    errorMsg += 'A server error occurred. Please try again later.';
                } else if (xhr.responseText) {
                    errorMsg += xhr.responseText;
                }
                $detailsContent.html(`
                    <div class="alert alert-danger m-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${errorMsg}
                    </div>
                `);
            }
        });
    });
}
// Attach handler on page load
attachViewDetailsHandler();
setInterval(pollForms, 10000);
</script>
{% endblock %}
